<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>ASTCå’ŒETC2</title>
    <url>/xiaomin/2026/01/02/ASTC_ETC2/</url>
    <content><![CDATA[æœ€è¿‘é¡¹ç›®ä¸­é‡åˆ°äº†å›¾ç‰‡å‘ç³Šçš„é—®é¢˜ï¼ŒæŸ¥æ‰¾å‘ç°æ˜¯è·Ÿå›¾ç‰‡çš„å‹ç¼©æ ¼å¼æœ‰å…³ã€‚æˆ‘ä»¬æ˜¯ä¸€ä¸ªè€é¡¹ç›®ï¼Œç”¨çš„æ˜¯ETC2å‹ç¼©æ ¼å¼ï¼Œå› ä¸ºETC2å¯ä»¥æ”¯æŒå¸‚åœºä¸Šç»å¤§å¤šæ•°çš„è®¾å¤‡ï¼Œç‰¹åˆ«æ˜¯ä¸€äº›ä½ç«¯æœºã€‚æˆ‘ä»¬é¡¹ç›®ä¸»è¦æ˜¯é¢å‘ä¸œå—äºšå›½å®¶ï¼Œä½ç«¯æœºæ¯”è¾ƒå¤šï¼Œæ‰€ä»¥é€‰æ‹©äº†ETC2ï¼Œä½†æ˜¯å‘å±•è‡³ä»Šï¼Œä¸œå—äºšç©å®¶çš„è®¾å¤‡æ€§èƒ½æ›´å¥½äº†ã€‚æˆ‘ä»¬åšè¿‡ä¸€æ¬¡åŸ‹ç‚¹ç»Ÿè®¡ç©å®¶çš„è®¾å¤‡ASTCæ”¯æŒç‡ï¼Œå‡ ä¹å äº†ç»å¤§éƒ¨åˆ†ï¼Œæ‰€ä»¥æˆ‘ä»¬é€‰æ‹©äº†å‹ç¼©è´¨é‡æ›´å¥½çš„ASTCã€‚
æ•°æ®æ¥æºï¼šhttps://developer.android.google.cn/guide/playcore/asset-delivery/texture-compression?hl=zh-cn
è®©æˆ‘å…ˆåˆ†åˆ«ä»‹ç»ä¸€ä¸‹ASTCå’ŒETC2çš„å‹ç¼©åŸç†ï¼šä¸€ã€ETC2ETCï¼ˆEricsson Texture Compressionï¼‰æœ€åˆä¸ºç§»åŠ¨è®¾å¤‡å¼€å‘ï¼Œå¦‚ä»Šå®ƒæ˜¯å®‰å“çš„æ ‡å‡†å‹ç¼©æ–¹æ¡ˆã€‚å…¶åŸç†ç®€å•æ¥è¯´ï¼Œæ˜¯å°†4Ã—4 çš„åƒç´ å—ç¼–ç ä¸º2Ã—4æˆ–4Ã—2åƒç´ çš„ä¸Šä¸‹æˆ–è€…å·¦å³ä¸¤ä¸ªå—çš„æ–¹æ³•ï¼Œæ¯ä¸ªå—æŒ‡å®šä¸€ä¸ªåŸºè‰²ï¼Œæ¯ä¸ªåƒç´ çš„é¢œè‰²é€šè¿‡ä¸€ä¸ªç¼–ç ä¸ºç›¸å¯¹äºè¿™äº›åŸºè‰²åç§»çš„ç°åº¦å€¼ç¡®å®šã€‚æ‰€ä»¥æ¯ä¸ªå—æ˜¯4 Ã— 4 Ã— 8 &#x3D; 128 bit| A A | B B || A A | B B || A A | B B || A A | B B | æ¯åƒç´ é¢œè‰²è®¡ç®—ï¼š  pixel &#x3D; baseColor + modifier[index]
äºŒã€ASTCASTCç›¸æ¯”äºETC2æœ‰æ›´åŠ çµæ´»çš„åˆ‡å—ç­–ç•¥ï¼Œå¯é€‰çš„æœ‰4Ã—4ã€5Ã—5ã€6Ã—6ã€8Ã—8ã€10Ã—10ã€12Ã—12ã€‚
è™½ç„¶æœ‰è¿™ä¹ˆå¤šçš„é€‰æ‹©ï¼Œä½†ä¸å˜çš„æ˜¯æ¯ä¸ªå—ä¾æ—§æ˜¯å›ºå®š128bitã€‚æ¯ä¸ªå—ä¼šè‡ªé€‚åº”åˆ†åŒºï¼Œ åˆ†ä¸º 1~4 ä¸ªå­åŒºåŸŸï¼ˆsubsetsï¼‰ï¼Œæ¯ä¸ªåŒºåŸŸå†…é¢œè‰²æ¸å˜å¹³æ»‘ã€‚åˆ†åŒºæ–¹å¼é€šè¿‡ä¸€ä¸ª Partition ID æ§åˆ¶ï¼ˆåŸºäºé¢„å®šä¹‰çš„åˆ†åŒºæ¨¡å¼è¡¨ï¼Œå‡ ç™¾ç§å¯èƒ½ï¼‰ã€‚ æ¯ä¸ªåŒºåŸŸä½¿ç”¨ä¸¤ä¸ªç«¯ç‚¹è‰²ï¼ˆendpoint colorsï¼‰ï¼Œå—å†…åƒç´ é¢œè‰²é€šè¿‡ æ’å€¼ å¾—åˆ°ã€‚æ¯ä¸ªå—å­˜å‚¨äº†ä»¥ä¸‹æ•°æ®ï¼šâ— åˆ†åŒºæ•°é‡â— åˆ†åŒºæ¨¡å¼ IDâ— ç«¯ç‚¹è‰²æ¨¡å¼ï¼ˆbit æ·±åº¦ï¼‰â— ç´¢å¼•ç²¾åº¦ è¿™æ · GPU è§£ç å™¨çŸ¥é“å¦‚ä½•æŒ‰è§„åˆ™é‡å»ºé¢œè‰²ã€‚è§£ç ä¸€ä¸ªå—çš„æµç¨‹ï¼š

ä» 16 å­—èŠ‚ä¸­è¯»å–æ¨¡å¼ä¿¡æ¯ã€‚
ç¡®å®šåˆ†åŒºæ¨¡å¼ï¼Œå°†åƒç´ åˆ’åˆ†åˆ°å­åŒºåŸŸã€‚
è¯»å–å¹¶åé‡åŒ–ç«¯ç‚¹è‰²ã€‚
æ ¹æ®ç´¢å¼•æƒé‡åœ¨ç«¯ç‚¹è‰²é—´æ’å€¼ã€‚
å¾—åˆ°æœ€ç»ˆåƒç´ é¢œè‰²ã€‚GPU ä¸­è¿™æ˜¯ç¡¬ä»¶çº§å¹¶è¡Œè§£ç ï¼Œå‡ ä¹æ²¡æœ‰æ€§èƒ½æŸè€—ã€‚ï¼ˆä¸€ï¼‰åˆ†åŒºæ•°é‡æ ¹æ®å—çš„å°ºå¯¸çš„ä¸åŒï¼Œå—çš„åˆ†åŒºæ•°é‡ä¹Ÿä¸åŒã€‚ä¸€èˆ¬æ¥è¯´å°ºå¯¸è¶Šå¤§ï¼Œåˆ†åŒºè¶Šå°‘ã€‚å› ä¸ºæ¯ä¸€ä¸ªåˆ†åŒºéƒ½éœ€è¦å‚¨å­˜ä¸€å¯¹ç«¯ç‚¹è‰²å’Œç´¢å¼•ç²¾åº¦ï¼Œè€Œå—çš„å¤§å°æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥åˆ†åŒºæ•°é‡ä¸€èˆ¬ä¸å°ºå¯¸æˆåæ¯”å…³ç³»ã€‚




å—å°ºå¯¸
å¸¸è§åˆ†åŒºæ•°



4Ã—4
1~3ï¼ˆç”šè‡³ 4ï¼‰


6Ã—6
1~2


8Ã—8
1ï¼ˆå¶å°” 2ï¼‰


12Ã—12
å‡ ä¹éƒ½æ˜¯ 1


è€Œåˆ†åŒºæ–¹å¼æœ‰å¾ˆå¤šç§ï¼Œé€šè¿‡é¢„å®šä¹‰çš„ Partition IDæ§åˆ¶ã€‚ä¾‹å¦‚æœ‰ï¼šæ¨ªç€åˆ‡ &#x2F; ç«–ç€åˆ‡ &#x2F; æ–œç€åˆ‡ &#x2F; Z å­—å½¢ &#x2F; ä¸è§„åˆ™ç­‰ã€‚è¿™äº›çµæ´»çš„åˆ†åŒºæ–¹å¼å†³å®šäº†ASTCå…·æœ‰æ›´ç²¾å‡†çš„é¢œè‰²æ’å€¼ã€‚ï¼ˆäºŒï¼‰ç«¯ç‚¹è‰²æ¨¡å¼ç«¯ç‚¹è‰²æ¨¡å¼ç®€å•æ¥è¯´å°±æ˜¯æ˜¾ç¤ºç«¯ç‚¹è‰²é¢œè‰²çš„æ¨¡å¼ï¼Œé€šå¸¸æœ‰ï¼šRGBã€Lã€æŸ¥åˆ†ã€HDRæ¨¡å¼ï¼ŒASTCå¯ä»¥æ ¹æ®æ¯ä¸ªåƒç´ éœ€è¦å­˜å‚¨çš„é¢œè‰²ç±»å‹æ¥è‡ªç”±é€‰æ‹©é¢œè‰²æ¨¡å¼ã€‚æ¯”å¦‚æœ‰ä¸€ä¸ªè‰²å—åªæœ‰äº®æš—å˜åŒ–ï¼Œé‚£å°±åªéœ€è¦å­˜å‚¨Alphaå€¼ï¼Œå¦‚æœè¿™æ—¶å€™è¿˜å­˜å‚¨RGBé¢œè‰²å°±ä¼šæµªè´¹bitï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™å¯ä»¥é€‰æ‹©äº®åº¦æ¨¡å¼ï¼ˆLï¼‰ï¼›è€ŒRGBæ¨¡å¼å¯ä»¥è¡¨è¾¾çš„é¢œè‰²æœ€è‡ªç”±ï¼Œæ‰€ä»¥å®ƒé€‚åˆé¢œè‰²è´Ÿè´£çš„å—ã€‚ï¼ˆä¸‰ï¼‰ç´¢å¼•ç²¾åº¦ï¼š ç´¢å¼•ç²¾åº¦ &#x3D; æ¯ä¸ªåƒç´ ç”¨å¤šå°‘ bitï¼Œæ¥è¡¨ç¤ºå®ƒåœ¨ç«¯ç‚¹è‰²ä¹‹é—´çš„ä½ç½®ï¼ˆæ’å€¼æ¯”ä¾‹ï¼‰æƒ³è±¡ä½ æœ‰ä¸¤ç§é¢œè‰²ï¼šâ— å·¦ç«¯ï¼šé»‘è‰²â— å³ç«¯ï¼šç™½è‰²ä¸­é—´æœ‰ä¸€ä¸ªæ»‘å—ï¼Œå†³å®šé¢œè‰²åå‘å“ªä¸€è¾¹ ä½ç´¢å¼•ç²¾åº¦ï¼ˆ2 bitï¼‰  ï¼šå¯é€‰ä½ç½®ï¼š4 ä¸ª[é»‘]â”€â”€â”¬â”€â”€â”¬â”€â”€â”¬â”€â”€[ç™½]      0  1  2  3åªèƒ½é€‰è¿™ 4 ä¸ªä½ç½®ä¹‹ä¸€ï¼Œ é¢œè‰²æ˜¯ è·³ç€å˜çš„ é«˜ç´¢å¼•ç²¾åº¦ï¼ˆ6 bitï¼‰å¯é€‰ä½ç½®ï¼š64 ä¸ª[é»‘]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ç™½]  é¢œè‰²å˜åŒ– éå¸¸å¹³æ»‘æ‰€ä»¥ç´¢å¼•ç²¾åº¦ä»£è¡¨è¿™ä¸ªåƒç´ èƒ½åœ¨ä¿©ä¸ªç«¯ç‚¹è‰²ä¸­é€‰æ‹©ç”¨ä»€ä¹ˆé¢œè‰²ï¼Œè¶Šé«˜ï¼Œåˆ™é¢œè‰²è¶Šå¹³æ»‘ã€‚
]]></content>
      <categories>
        <category>Unityå¼€å‘</category>
      </categories>
  </entry>
  <entry>
    <title>Unityåç¨‹çš„åŸç†</title>
    <url>/xiaomin/2025/10/02/IEnumerator/</url>
    <content><![CDATA[ä¸€ã€åç¨‹çš„æ¦‚å¿µ

åç¨‹ä¸æ˜¯çº¿ç¨‹  â—‹ å®ƒä¸ä¼šå¹¶è¡Œæ‰§è¡Œï¼Œä¹Ÿä¸ä¼šå ç”¨ç³»ç»Ÿçº¿ç¨‹  â—‹ å…¨éƒ¨åœ¨ Unity ä¸»çº¿ç¨‹æ‰§è¡Œ
åç¨‹æ˜¯å¯æš‚åœçš„é€»è¾‘ç‰‡æ®µ  â—‹ ä½¿ç”¨ IEnumeratorï¼Œé€šè¿‡ yield return æš‚åœ  â—‹ æ¯æ¬¡æš‚åœæ—¶ä¿å­˜å½“å‰çŠ¶æ€ï¼Œä¸‹æ¬¡æ¢å¤ç»§ç»­æ‰§è¡Œ
åç¨‹çš„ä½œç”¨  â—‹ åˆ†å¸§æ‰§è¡Œé€»è¾‘ï¼ˆä¾‹å¦‚æŠ€èƒ½å‰æ‘‡ã€Buff æŒç»­ï¼‰  â—‹ å»¶è¿Ÿé€»è¾‘ï¼ˆç­‰å¾…ä¸€æ®µæ—¶é—´æˆ–ç­‰å¾…ç‰©ç†å®Œæˆï¼‰äºŒã€C# å±‚é¢çš„å®ç°æœºåˆ¶

Unity çš„åç¨‹æœ¬è´¨ä¾èµ– C# ç¼–è¯‘å™¨ç”Ÿæˆçš„çŠ¶æ€æœºï¼šIEnumerator MyCoroutine(){    print(â€œå¼€å§‹â€);    yield return null;    print(â€œä¸‹ä¸€å¸§ç»§ç»­â€);}1ï¸ ç¼–è¯‘å™¨è½¬æ¢ç¼–è¯‘å™¨ä¼šæŠŠè¿™ä¸ªæ–¹æ³•è½¬æ¢æˆä¸€ä¸ª çŠ¶æ€æœºç±»ï¼š
class MyCoroutineStateMachine : IEnumerator&#123;    int state = 0;    public bool MoveNext()    &#123;        switch (state)        &#123;            case 0:                print(&quot;å¼€å§‹&quot;);                state = 1;                return true; // yield return null            case 1:                print(&quot;ä¸‹ä¸€å¸§ç»§ç»­&quot;);                state = -1;                return false; // åç¨‹ç»“æŸ        &#125;        return false;    &#125;&#125;
â— æ¯æ¬¡è°ƒç”¨ MoveNext() å°±æ¨è¿›åç¨‹ä¸€æ¬¡â— yield return æœ¬è´¨æ˜¯ï¼š

æš‚åœå‡½æ•°
ä¿å­˜ state
è¿”å›ä¸€ä¸ªå€¼ç»™è°ƒåº¦å™¨ï¼ˆæ¯”å¦‚ null, WaitForSeconds, WaitForFixedUpdateï¼‰2ï¸ åç¨‹çš„å…³é”®å­—æ®µâ— stateï¼šè®°å½•åç¨‹æ‰§è¡Œåˆ°å“ªä¸€æ­¥â— Currentï¼šå­˜å‚¨ yield return çš„å¯¹è±¡ï¼Œç”¨äºè°ƒåº¦å™¨åˆ¤æ–­ä½•æ—¶æ¢å¤â— MoveNext()ï¼šæ¯å¸§ç”± Unity è°ƒåº¦è°ƒç”¨ä¸‰ã€Unity å±‚é¢çš„è°ƒåº¦æœºåˆ¶Unity åœ¨å†…éƒ¨æœ‰ä¸€ä¸ª Coroutine Managerï¼š1ï¸ è°ƒåº¦é˜Ÿåˆ—Unity ä¼šç»´æŠ¤ä¸€ä¸ª åˆ—è¡¨&#x2F;é˜Ÿåˆ—ï¼Œå­˜å‚¨æ‰€æœ‰æŒ‚èµ·çš„åç¨‹ï¼šList waitingCoroutinesâ— æ¯ä¸ªåç¨‹å¯¹åº”ä¸€ä¸ª IEnumerator çŠ¶æ€æœºâ— æ¯å¸§æ›´æ–°æ—¶ï¼ŒUnity éå†åˆ—è¡¨ï¼šâ— åˆ¤æ–­ Current è¿”å›çš„å¯¹è±¡ç±»å‹  â—‹ null â†’ ä¸‹ä¸€å¸§æ¢å¤  â—‹ WaitForSeconds â†’ ç­‰å¾…æ—¶é—´åˆ°å†æ¢å¤  â—‹ WaitForFixedUpdate â†’ ç­‰ FixedUpdate åæ¢å¤  â—‹ WaitForEndOfFrame â†’ æ¸²æŸ“åæ¢å¤2ï¸ æ¢å¤æ—¶æœºyield return ç±»å‹	æ¢å¤æ—¶æœºnull	ä¸‹ä¸€å¸§ Update å®Œå &#x2F; LateUpdate å‰WaitForFixedUpdate	ä¸‹ä¸€æ¬¡ FixedUpdate ç»“æŸåWaitForEndOfFrame	æœ¬å¸§æ¸²æŸ“å®ŒæˆåWaitForSeconds(x)	ç­‰ x ç§’åæ¢å¤3ï¸ æ‰§è¡Œæµç¨‹ä»¥ yield return null ä¸ºä¾‹ï¼šå¸§ nï¼š


StartCoroutine(MyCoroutine) è°ƒç”¨
IEnumerator ç”ŸæˆçŠ¶æ€æœºï¼ŒåŠ å…¥ç­‰å¾…é˜Ÿåˆ—
MyCoroutine ç¬¬ä¸€æ¬¡ MoveNext æ‰§è¡Œåˆ° yield return null â†’ æš‚åœï¼Œstate ä¿å­˜å¸§ n+1ï¼š
Unity éå†ç­‰å¾…é˜Ÿåˆ—
MoveNext() å†æ¬¡è°ƒç”¨ â†’ åç¨‹ç»§ç»­æ‰§è¡Œ
æ³¨æ„ï¼šçŠ¶æ€æœºä¿å­˜äº†å±€éƒ¨å˜é‡å’Œæ‰§è¡Œä½ç½®ï¼Œè¿™å°±æ˜¯â€œè·¨å¸§ä¿æŒä¸Šä¸‹æ–‡â€çš„ç§˜å¯†ã€‚å››ã€åç¨‹å®ç°çš„æ ¸å¿ƒåŸç†æ€»ç»“




C# å±‚é¢  â—‹ IEnumerator + ç¼–è¯‘å™¨çŠ¶æ€æœº  â—‹ yield return â†’ ä¿å­˜çŠ¶æ€ + æš‚åœæ‰§è¡Œ
Unity å±‚é¢  â—‹ Coroutine Manager ç»´æŠ¤æŒ‚èµ·é˜Ÿåˆ—  â—‹ æ¯å¸§éå†åˆ¤æ–­æ˜¯å¦æ¢å¤  â—‹ æ¢å¤æ—¶æœºä¾èµ–è¿”å›å¯¹è±¡ç±»å‹
ç‰¹æ€§  â—‹ éå¹¶è¡Œï¼šåç¨‹åªæ˜¯åœ¨ä¸»çº¿ç¨‹åˆ†å¸§æ‰§è¡Œ  â—‹ å¯è·¨å¸§ä¿æŒå±€éƒ¨å˜é‡çŠ¶æ€  â—‹ å¯å»¶è¿Ÿé€»è¾‘&#x2F;æ§åˆ¶æ‰§è¡Œé¡ºåºäº”ã€ä¸¾ä¾‹ï¼šæŠ€èƒ½å‰æ‘‡ç³»ç»Ÿå‡è®¾åšæˆ˜æ–—ç³»ç»Ÿï¼š

IEnumerator SkillCast(){    isCasting &#x3D; true;    &#x2F;&#x2F; å‰æ‘‡ 0.5 ç§’    yield return new WaitForSeconds(0.5f);
DealDamage(); // æ”»å‡»å‘½ä¸­
isCasting = false;

}æ‰§è¡ŒåŸç†ï¼š

StartCoroutine â†’ çŠ¶æ€æœºç”Ÿæˆ â†’ å…¥é˜Ÿ
MoveNext æ‰§è¡Œ â†’ æš‚åœåœ¨ WaitForSeconds
æ¯å¸§æ£€æŸ¥æ—¶é—´æ˜¯å¦åˆ° â†’ æ¡ä»¶æ»¡è¶³ â†’ MoveNext ç»§ç»­ â†’ DealDamage æ‰§è¡Œ
çŠ¶æ€æœºç»“æŸ â†’ ä»é˜Ÿåˆ—ç§»é™¤


ğŸ’¡ è¿™æ ·å°±èƒ½å®ç° åˆ†å¸§æ‰§è¡Œã€å»¶è¿Ÿæ•ˆæœã€çŠ¶æ€ä¿æŒï¼Œè€Œä¸é˜»å¡ä¸»çº¿ç¨‹

å…­ã€state çš„æœ¬è´¨åœ¨ Unity &#x2F; C# åç¨‹ä¸­ï¼šstate ä¿å­˜çš„æ˜¯ åç¨‹æ‰§è¡Œåˆ°äº†å“ªä¸€æ­¥ã€‚æ¢å¥è¯è¯´ï¼Œå®ƒæ˜¯ç¼–è¯‘å™¨ç”Ÿæˆçš„çŠ¶æ€æœºâ€œæŒ‡é’ˆâ€ï¼Œå‘Šè¯‰åç¨‹â€œä¸‹ä¸€æ¬¡ä»å“ªè¡Œä»£ç ç»§ç»­æ‰§è¡Œâ€ã€‚IEnumerator MyCoroutine(){    int x &#x3D; 0;    print(â€œå¼€å§‹â€);    yield return null;     &#x2F;&#x2F; æš‚åœç‚¹ 1    x +&#x3D; 1;    print(â€œä¸‹ä¸€å¸§ç»§ç»­â€);    yield return null;     &#x2F;&#x2F; æš‚åœç‚¹ 2    print(â€œç»“æŸâ€);} C# ç¼–è¯‘å™¨ä¼šç”Ÿæˆå¤§è‡´è¿™æ ·ä¸€ä¸ªçŠ¶æ€æœºç±»ï¼š  
class MyCoroutineStateMachine : IEnumerator&#123;    int state = 0;      // &lt;--- ä¿å­˜å½“å‰ä½ç½®    int x;              // &lt;--- ä¿å­˜å±€éƒ¨å˜é‡    public object Current &#123; get; private set; &#125;    public bool MoveNext()    &#123;        switch (state)        &#123;            case 0:                x = 0;                 print(&quot;å¼€å§‹&quot;);                Current = null;                state = 1;  // ä¸‹ä¸€æ¬¡ MoveNext ä» case 1 å¼€å§‹                return true;            case 1:                x += 1;                print(&quot;ä¸‹ä¸€å¸§ç»§ç»­&quot;);                Current = null;                state = 2;  // ä¸‹ä¸€æ¬¡ MoveNext ä» case 2 å¼€å§‹                return true;            case 2:                print(&quot;ç»“æŸ&quot;);                state = -1; // åç¨‹ç»“æŸ                return false;        &#125;        return false;    &#125;&#125;

æ€»ç»“ state ä¿å­˜çš„å†…å®¹

åç¨‹æ‰§è¡Œä½ç½®  â—‹ å“ªä¸ª yield return æš‚åœäº†  â—‹ ä¸‹ä¸€æ¬¡ MoveNext() åº”è¯¥ä»å“ªä¸ªä½ç½®ç»§ç»­
å±€éƒ¨å˜é‡å’Œå‚æ•°çš„å¿«ç…§  â—‹ ä¸æ˜¯ç›´æ¥ä¿å­˜åœ¨ state é‡Œï¼Œä½†ç¼–è¯‘å™¨ä¼šæŠŠå®ƒä»¬å˜æˆçŠ¶æ€æœºçš„æˆå‘˜å˜é‡  â—‹ ä¿è¯è·¨å¸§ä¿æŒå€¼
ç‰¹æ®Šå€¼ -1  â—‹ è¡¨ç¤ºåç¨‹å·²ç»ç»“æŸä¸ºä»€ä¹ˆéœ€è¦ stateï¼Ÿå¦‚æœæ²¡æœ‰ stateï¼Œåç¨‹å°±æ²¡åŠæ³•è·¨å¸§ä¿å­˜ä¸Šä¸‹æ–‡ï¼šâ— ä½ çš„å‰æ‘‡æŠ€èƒ½æŒ‚èµ· 0.5 ç§’â— ä¸‹ä¸€å¸§ç»§ç»­æ‰§è¡Œ DealDamageâ— å¦‚æœæ²¡æœ‰ stateï¼Œå°±ä¸çŸ¥é“è¯¥ä»å“ªä¸€è¡Œç»§ç»­ï¼Œä¹Ÿæ— æ³•ä¿ç•™å±€éƒ¨å˜é‡ xä¸ƒã€ ä½“æ˜¯å¦‚ä½•åˆ¤æ–­ç»§ç»­æ‰§è¡Œçš„æ¡ä»¶ä¸€ã€åç¨‹æ¢å¤çš„æ ¸å¿ƒé€»è¾‘
åç¨‹æœ¬èº«æ˜¯ä¸€ä¸ª IEnumerator çŠ¶æ€æœº  â—‹ state ä¿å­˜ä½ç½®  â—‹ Current ä¿å­˜ yield return çš„å€¼
Unity æ¯å¸§ä¼šéå†æŒ‚èµ·çš„åç¨‹é˜Ÿåˆ—ï¼ŒæŸ¥çœ‹ æ¯ä¸ªåç¨‹çš„ Current è¿”å›å€¼ï¼Œå†³å®šæ˜¯å¦å¯ä»¥è°ƒç”¨ MoveNext() ç»§ç»­æ‰§è¡Œã€‚æ‰€ä»¥åˆ¤æ–­â€œæ˜¯å¦ç»§ç»­æ‰§è¡Œâ€ï¼Œå®Œå…¨ä¾èµ– yield è¿”å›çš„å¯¹è±¡ç±»å‹ã€‚äºŒã€ä¸åŒ yield å¯¹åº”çš„æ¡ä»¶




yield return ç±»å‹
Unity åˆ¤æ–­æ¡ä»¶ï¼ˆä½•æ—¶è°ƒç”¨ MoveNextï¼‰
è¯´æ˜



null
ä¸‹ä¸€å¸§ Update ç»“æŸ
è·¨ä¸€å¸§ï¼Œç«‹å³æ¢å¤


WaitForSeconds(seconds)
ç­‰å¾…ç´¯è®¡æ—¶é—´ &gt;&#x3D; seconds
Unity å†…éƒ¨è®¡æ—¶å™¨ï¼Œæ¯å¸§ç´¯åŠ  deltaTimeï¼Œæ—¶é—´åˆ°æ¢å¤


WaitForFixedUpdate
FixedUpdate å®Œæˆ
ä¸‹ä¸€æ¬¡ç‰©ç†å¸§ç»“æŸåæ¢å¤


WaitForEndOfFrame
æœ¬å¸§æ¸²æŸ“å®Œæˆ
åœ¨æ¸²æŸ“ç®¡çº¿æœ«å°¾æ¢å¤ï¼ˆLateUpdate åï¼‰


è‡ªå®šä¹‰ yield å¯¹è±¡ï¼ˆICustomYieldInstructionï¼‰
keepWaiting &#x3D;&#x3D; false
è‡ªå®šä¹‰æ¡ä»¶åˆ¤æ–­ï¼Œè¿”å› false æ—¶æ¢å¤


ä¸‰ã€å†…éƒ¨åŸç†å‡è®¾åç¨‹é˜Ÿåˆ—æ˜¯è¿™æ ·ï¼šList waitingCoroutines; æ¯å¸§å¤§è‡´ä¼ªä»£ç ï¼š  
for each coroutine in waitingCoroutines:    object yieldObj = coroutine.Current;        if (CanResume(yieldObj)):        bool hasNext = coroutine.MoveNext();        if (!hasNext) remove from waitingCoroutines

CanResume(yieldObj) çš„é€»è¾‘ï¼š  
bool CanResume(object yieldObj)&#123;    if (yieldObj == null) return true; // ä¸‹ä¸€å¸§ç«‹å³æ¢å¤    if (yieldObj is WaitForSeconds wfs) return wfs.timeElapsed &gt;= wfs.duration;    if (yieldObj is WaitForFixedUpdate) return FixedUpdateDoneThisFrame;    if (yieldObj is WaitForEndOfFrame) return EndOfFrameReached;    if (yieldObj is ICustomYieldInstruction c) return !c.keepWaiting;    return false;&#125;]]></content>
      <categories>
        <category>Unityå¼€å‘</category>
      </categories>
  </entry>
  <entry>
    <title>Toluaæ¡†æ¶å­¦ä¹ ï¼ˆWrapæ–‡ä»¶ï¼‰</title>
    <url>/xiaomin/2024/10/02/ToLua_Wrap/</url>
    <content><![CDATA[ä¸€ã€ä»€ä¹ˆæ˜¯Wrapæ–‡ä»¶Wrapï¼ˆåŒ…è£…ç±»ï¼‰ æ˜¯ ToLua è‡ªåŠ¨ç”Ÿæˆçš„ C# é™æ€ç±»ï¼Œä½œä¸º Lua å’Œ C# ä¹‹é—´çš„æ¡¥æ¢ã€‚æ¯ä¸ªéœ€è¦å¯¼å‡ºåˆ° Lua çš„ C# ç±»éƒ½ä¼šç”Ÿæˆä¸€ä¸ªå¯¹åº”çš„ XxxWrap.cs æ–‡ä»¶ã€‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  Lua è„šæœ¬    		â”‚ â”€â”€â”€â”€â”€â”€â–¶ â”‚  XxxWrap.cs       â”‚ â”€â”€â”€â”€â”€â”€â–¶ â”‚  åŸç”Ÿ C# ç±»          â”‚â”‚ go:SetActive 	â”‚         	â”‚ (è‡ªåŠ¨ç”Ÿæˆæ¡¥æ¢)  	     â”‚        		â”‚ GameObject            â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜äºŒã€ç”Ÿæˆæµç¨‹æ€»è§ˆâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ 1. CustomSettings 	     â”‚  â† ç”¨æˆ·é…ç½®è¦å¯¼å‡ºçš„ç±»å‹åˆ—è¡¨â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         	     â–¼â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ 2. ToLuaMenu     		     â”‚  â† èœå•å…¥å£ï¼Œå¤„ç†ç±»å‹ä¾èµ–â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         	     â–¼â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ 3. ToLuaExport   		     â”‚  â† æ ¸å¿ƒï¼šé€šè¿‡åå°„åˆ†æç±»å‹ï¼Œç”Ÿæˆä»£ç â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         	     â–¼â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ 4. XxxWrap.cs    		     â”‚  â† è¾“å‡ºï¼šç”Ÿæˆçš„åŒ…è£…ç±»æ–‡ä»¶â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         	     â–¼â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ 5. LuaBinder.cs  		     â”‚  â† æ±‡æ€»ï¼šæ³¨å†Œæ‰€æœ‰ Wrap åˆ° LuaStateâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜CustomSettingä»£ç ç»“æ„å¦‚ä¸‹ï¼š
// å®šä¹‰è¦å¯¼å‡ºåˆ° Lua çš„ç±»å‹public static BindType[] customTypeList = &#123;    _GT(typeof(GameObject)),           // å¯¼å‡º GameObject    _GT(typeof(Transform)),            // å¯¼å‡º Transform    _GT(typeof(UILabel)),              // å¯¼å‡º NGUI ç»„ä»¶    // ... æ›´å¤šç±»å‹&#125;;// å®šä¹‰è¦å¯¼å‡ºçš„å§”æ‰˜ç±»å‹public static DelegateType[] customDelegateList = &#123;    _DT(typeof(Action)),    _DT(typeof(UnityAction)),&#125;;ç”ŸæˆWrapæ–‡ä»¶æ¥å£ï¼š[MenuItem(&quot;Lua/Gen Lua Wrap Files&quot;, false, 1)]public static void GenerateClassWraps() &#123;    // 1. è·å–é…ç½®çš„ç±»å‹åˆ—è¡¨    BindType[] typeList = CustomSettings.customTypeList;        // 2. å¤„ç†ç»§æ‰¿å…³ç³»ï¼Œè‡ªåŠ¨æ·»åŠ åŸºç±»    BindType[] list = GenBindTypes(typeList);        // 3. éå†æ¯ä¸ªç±»å‹ï¼Œç”Ÿæˆ Wrap    for (int i = 0; i &lt; list.Length; i++) &#123;        ToLuaExport.Clear();        ToLuaExport.className = list[i].name;        ToLuaExport.type = list[i].type;        // ... è®¾ç½®å…¶ä»–å±æ€§        ToLuaExport.Generate(CustomSettings.saveDir);  // æ ¸å¿ƒç”Ÿæˆé€»è¾‘    &#125;&#125;
C#ç±»è½¬åŒ–æˆWrapæ–‡ä»¶åŸç†è¿™ä¸ªå‡½æ•°ä¼šé€šè¿‡åå°„æ”¶é›†ç±»é‡Œæ‰€æœ‰çš„æ–¹æ³•ã€å±æ€§ã€äº‹ä»¶ã€å­—æ®µç­‰ã€‚ç„¶åæ ¹æ®å„æ–¹æ³•å’Œå±æ€§çš„å°è£…è¿›è¡Œç­›é€‰ï¼Œå¦‚ç§æœ‰å˜é‡å’Œå‡½æ•°å°±ä¼šè¢«å‰”é™¤æ‰ä¸ä¼šæ”¾å…¥Wrapæ–‡ä»¶å½“ä¸­ï¼Œç›¸åº”Luaä¹Ÿè°ƒç”¨ä¸åˆ°ã€‚
public static void Generate(string dir) &#123;    // 1. åˆå§‹åŒ–    InitMethods();       // æ”¶é›†æ‰€æœ‰æ–¹æ³•    InitPropertyList();  // æ”¶é›†æ‰€æœ‰å±æ€§ã€å­—æ®µã€äº‹ä»¶    InitCtorList();      // æ”¶é›†æ‰€æœ‰æ„é€ å‡½æ•°        // 2. å¼€å§‹ç”Ÿæˆä»£ç     BeginCodeGen();      // ç”Ÿæˆç±»å®šä¹‰å¤´        // 3. ç”Ÿæˆå„éƒ¨åˆ†ä»£ç     GenRegisterFunction();      // ç”Ÿæˆ Register å‡½æ•°    GenConstructFunction();     // ç”Ÿæˆæ„é€ å‡½æ•°åŒ…è£…    GenItemPropertyFunction();  // ç”Ÿæˆç´¢å¼•å™¨    GenFunctions();             // ç”Ÿæˆæ‰€æœ‰æ–¹æ³•åŒ…è£…    GenIndexFunc();             // ç”Ÿæˆ __index å…ƒæ–¹æ³•    GenNewIndexFunc();          // ç”Ÿæˆ __newindex å…ƒæ–¹æ³•    GenEventFunctions();        // ç”Ÿæˆäº‹ä»¶ç›¸å…³å‡½æ•°        // 4. ç»“æŸç”Ÿæˆ    EndCodeGen(dir);     // ä¿å­˜æ–‡ä»¶&#125;
ä¸‹é¢ä»¥æ”¶é›†æ–¹æ³•çš„å‡½æ•°ä¸¾ä¾‹ï¼Œå…¶ä»–ç±»å‹åŸºæœ¬ç›¸ä¼¼ï¼š
List&lt;_MethodBase&gt; list = new List&lt;_MethodBase&gt;();MethodInfo[] infos = type.GetMethods(BindingFlags.Instance | binding);for (int i = 0; i &lt; infos.Length; i++)&#123;    list.Add(new _MethodBase(infos[i]));&#125;for (int i = list.Count - 1; i &gt;= 0; --i)&#123;    //å»æ‰æ“ä½œç¬¦å‡½æ•°    if (list[i].Name.StartsWith(&quot;op_&quot;) || list[i].Name.StartsWith(&quot;add_&quot;) || list[i].Name.StartsWith(&quot;remove_&quot;))    &#123;        if (!IsNeedOp(list[i].Name))        &#123;            list.RemoveAt(i);        &#125;        continue;    &#125;    //æ‰”æ‰ unity3d åºŸå¼ƒçš„å‡½æ•°                    if (IsObsolete(list[i].Method))    &#123;        list.RemoveAt(i);    &#125;&#125;
ä¸‰ã€ç”Ÿæˆçš„ Wrap ä»£ç ç»“æ„ä»¥ UnityEngine_GameObjectWrap.cs ä¸ºä¾‹ï¼š
public class UnityEngine_GameObjectWrap&#123;    // ==================== 1. æ³¨å†Œå‡½æ•° ====================    public static void Register(LuaState L)    &#123;        // å¼€å§‹ç±»å®šä¹‰ï¼ŒæŒ‡å®šåŸºç±»        L.BeginClass(typeof(GameObject), typeof(UnityEngine.Object));    // æ³¨å†Œæ–¹æ³•    L.RegFunction(&quot;SetActive&quot;, SetActive);    L.RegFunction(&quot;GetComponent&quot;, GetComponent);    L.RegFunction(&quot;Find&quot;, Find);    L.RegFunction(&quot;New&quot;, _CreateUnityEngine_GameObject);  // æ„é€ å‡½æ•°        // æ³¨å†Œå…ƒæ–¹æ³•    L.RegFunction(&quot;__eq&quot;, op_Equality);    L.RegFunction(&quot;__tostring&quot;, ToLua.op_ToString);        // æ³¨å†Œå±æ€§ (getter, setter)    L.RegVar(&quot;transform&quot;, get_transform, null);        // åªè¯»    L.RegVar(&quot;layer&quot;, get_layer, set_layer);           // å¯è¯»å†™    L.RegVar(&quot;activeSelf&quot;, get_activeSelf, null);      // åªè¯»        L.EndClass();&#125;// ==================== 2. æ„é€ å‡½æ•°åŒ…è£… ====================[MonoPInvokeCallbackAttribute(typeof(LuaCSFunction))]static int _CreateUnityEngine_GameObject(IntPtr L)&#123;    int count = LuaDLL.lua_gettop(L);  // è·å–å‚æ•°æ•°é‡        if (count == 0) &#123;        // new GameObject()        GameObject obj = new GameObject();        ToLua.PushSealed(L, obj);        return 1;    &#125;    else if (count == 1 &amp;&amp; TypeChecker.CheckTypes&lt;string&gt;(L, 1)) &#123;        // new GameObject(name)        string arg0 = ToLua.ToString(L, 1);        GameObject obj = new GameObject(arg0);        ToLua.PushSealed(L, obj);        return 1;    &#125;    // ... å¤„ç†å…¶ä»–é‡è½½&#125;// ==================== 3. æ–¹æ³•åŒ…è£… ====================[MonoPInvokeCallbackAttribute(typeof(LuaCSFunction))]static int SetActive(IntPtr L)&#123;    try &#123;        // æ£€æŸ¥å‚æ•°æ•°é‡        ToLua.CheckArgsCount(L, 2);                // ä»æ ˆä¸Šè·å– self å¯¹è±¡        GameObject obj = (GameObject)ToLua.CheckObject(L, 1, typeof(GameObject));                // ä»æ ˆä¸Šè·å–å‚æ•°        bool arg0 = LuaDLL.luaL_checkboolean(L, 2);                // è°ƒç”¨çœŸæ­£çš„ C# æ–¹æ³•        obj.SetActive(arg0);                return 0;  // æ— è¿”å›å€¼    &#125;    catch (Exception e) &#123;        return LuaDLL.toluaL_exception(L, e);    &#125;&#125;// ==================== 4. å±æ€§ Getter ====================[MonoPInvokeCallbackAttribute(typeof(LuaCSFunction))]static int get_transform(IntPtr L)&#123;    object o = null;    try &#123;        o = ToLua.ToObject(L, 1);        GameObject obj = (GameObject)o;        Transform ret = obj.transform;        ToLua.Push(L, ret);  // å°†è¿”å›å€¼å‹å…¥æ ˆ        return 1;    &#125;    catch (Exception e) &#123;        return LuaDLL.toluaL_exception(L, e, o, &quot;attempt to get transform&quot;);    &#125;&#125;// ==================== 5. å±æ€§ Setter ====================[MonoPInvokeCallbackAttribute(typeof(LuaCSFunction))]static int set_layer(IntPtr L)&#123;    object o = null;    try &#123;        o = ToLua.ToObject(L, 1);        GameObject obj = (GameObject)o;        int arg0 = (int)LuaDLL.luaL_checknumber(L, 2);        obj.layer = arg0;        return 0;    &#125;    catch (Exception e) &#123;        return LuaDLL.toluaL_exception(L, e, o, &quot;attempt to set layer&quot;);    &#125;&#125;&#125;
ç”ŸæˆWrapç±»åéœ€è¦é€šè¿‡LuaBinderç»Ÿä¸€æ³¨å†Œåˆ°LuaStateï¼š
public static class LuaBinder&#123;    public static void Bind(LuaState L)    &#123;        L.BeginModule(null);              // å…¨å±€æ¨¡å—                // æ³¨å†Œå„ä¸ª Wrap        AnimationMgrWrap.Register(L);        CommonUtilsWrap.Register(L);        // ...         L.BeginModule(&quot;UnityEngine&quot;);     // UnityEngine å‘½åç©ºé—´        UnityEngine_GameObjectWrap.Register(L);        UnityEngine_TransformWrap.Register(L);        // ...        L.EndModule();                L.EndModule();    &#125;&#125;
å››ã€å…·ä½“Luaè°ƒç”¨åˆ°C#å‡½æ•°çš„æµç¨‹å½“ Lua è°ƒç”¨goï¼šSetActive(true)æ—¶ï¼š

Lua è°ƒç”¨ SetActive â†“
æŸ¥æ‰¾ GameObject metatable çš„ SetActive å‡½æ•° â†“
è°ƒç”¨ UnityEngine_GameObjectWrap.SetActive(IntPtr L) â†“
ä» Lua æ ˆè·å–å‚æ•°:
ä½ç½® 1: self (GameObject userdata)
ä½ç½® 2: true (boolean)   â†“


é€šè¿‡ ObjectTranslator å°† userdata è½¬æ¢ä¸º C# GameObject â†“
è°ƒç”¨çœŸæ­£çš„ C# æ–¹æ³•: obj.SetActive(true) â†“
è¿”å›ç»“æœåˆ° Lua æ ˆç¬¬ä¸€æ­¥åˆ°ç¬¬äºŒæ­¥æ¯”è¾ƒå¥½ç†è§£ï¼Œluaè°ƒç”¨SetActiveçš„æ—¶å€™é¦–å…ˆå°±æ˜¯æŸ¥æ‰¾GameObjectå…ƒè¡¨é‡Œæ˜¯å¦æœ‰SetActiveè¿™ä¸ªæ–¹æ³•ï¼Œæœ‰åˆ™è°ƒç”¨ã€‚è€Œç¬¬äºŒæ­¥åˆ°ç¬¬ä¸‰æ­¥å¯èƒ½ä¼šæœ‰ç‚¹ç–‘é—®ä¸ºä»€ä¹ˆå¯ä»¥ç›´æ¥è°ƒç”¨åˆ°Wrapæ–‡ä»¶ï¼Œè¦ç†è§£è¿™ä¸€ç‚¹éœ€è¦ç†è§£ToLuaæ˜¯å¦‚ä½•æŠŠWrapæ–‡ä»¶æ³¨å†Œåˆ°Luaè¡¨é‡Œçš„ã€‚çœ‹ä»£ç ï¼š

// C# ç«¯æ‰§è¡Œ Registerpublic static void Register(LuaState L)&#123;    L.BeginClass(typeof(GameObject), ...);    L.RegFunction(&quot;SetActive&quot;, SetActive);  // â† å…³é”®ï¼    L.EndClass();&#125;// RegFunction çš„å®ç°public void RegFunction(string name, LuaCSFunction func)&#123;    // æŠŠ C# å‡½æ•°è½¬æˆå†…å­˜åœ°å€ï¼ˆå‡½æ•°æŒ‡é’ˆï¼‰    IntPtr fn = Marshal.GetFunctionPointerForDelegate(func);        // è°ƒç”¨ C åº“ï¼ŒæŠŠè¿™ä¸ªå‡½æ•°æŒ‡é’ˆå­˜å…¥å½“å‰ Lua table    LuaDLL.tolua_function(L, name, fn);&#125;
å¯ä»¥çœ‹åˆ°åœ¨æ³¨å†Œçš„æ—¶å€™ä¼šå…ˆæŠŠC#çš„SetActiveå‡½æ•°è½¬æˆå‡½æ•°æŒ‡é’ˆç„¶åæ”¾å…¥Luaè¡¨é‡Œï¼Œä¹Ÿå°±æ˜¯è¯´Luaç«¯æ‰§è¡ŒSetActiveå‡½æ•°å°±æ˜¯ç›´æ¥æ‰§è¡Œçš„Wrapæ–‡ä»¶çš„SetActiveå‡½æ•°ï¼
]]></content>
      <categories>
        <category>Unityå¼€å‘</category>
      </categories>
  </entry>
</search>
